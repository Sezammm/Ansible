- name: Install and configure Bind (named) - DNS primary
  hosts: dns
  become: true

  vars:
    zone_name: "ziyotek.local"
    zone_file: "/var/named/ziyotek.local.db"
    forwarders:
      - "8.8.8.8"
      - "1.1.1.1"
    zone_records:
      - { name: "prdx-ansible101", ip: "192.168.3.200" }
      - { name: "prdx-nsprimary101", ip: "192.168.3.201" }
      - { name: "prdx-ntp101", ip: "192.168.3.202" }
      - { name: "prdx-db101", ip: "192.168.3.203" }
      - { name: "prdx-webserver101", ip: "192.168.3.204" }
      - { name: "prdx-haproxy101", ip: "192.168.3.205" }
      - { name: "prdx-nagios101", ip: "192.168.3.206" }
      - { name: "prdx-ftp101", ip: "192.168.3.207" }
      - { name: "prdx-nfs101", ip: "192.168.3.208" }
      - { name: "prdx-dprimary101", ip: "192.168.3.209" }
      - { name: "prdx-dworker101", ip: "192.168.3.210" }
      - { name: "prdx-dworker102", ip: "192.168.3.211" }

  tasks:

    - name: Install bind and tools
      yum:
        name:
          - bind
          - bind-utils
        state: present

    - name: Ensure named service enabled and started
      service:
        name: named
        state: started
        enabled: true

    - name: Create zone file from template
      template:
        src: ../templates/ziyotek.local.db.j2
        dest: "{{ zone_file }}"
        owner: root
        group: named
        mode: '0644'
      notify: restart named



    - name: Ensure zone block present
      ansible.builtin.blockinfile:
        path: /etc/named.conf
        marker: "// {mark} ANSIBLE MANAGED ZONE {{ zone_name }}"
        insertafter: 'include "/etc/named.rfc1912.zones";'
        block: |
          zone "{{ zone_name }}" IN {
              type master;
              file "{{ zone_file }}";
              allow-update { none; };
          };
      notify: restart named



    - name: Configure forwarders comment line
      lineinfile:
        path: /etc/named.conf
        regexp: 'forwarders\s*{'
        insertafter: '^options'
        line: "    // forwarders will be managed by Ansible - see below"

    - name: Replace options block forwarders
      replace:
        path: /etc/named.conf
        regexp: 'forwarders\\s*\\{[^}]*\\};'
        replace: 'forwarders { {{ forwarders | join("; ") }}; };'
      ignore_errors: true
      notify: restart named

    - name: Set SELinux file context for zone file
      shell: |
        chown root:named "{{ zone_file }}"
        restorecon -v "{{ zone_file }}" || true

    - name: Open DNS port in firewalld
      firewalld:
        port: 53/tcp
        permanent: true
        immediate: true
        state: enabled

    - name: Open DNS UDP port in firewalld
      firewalld:
        port: 53/udp
        permanent: true
        immediate: true
        state: enabled

  handlers:
    - name: restart named
      service:
        name: named
        state: restarted
