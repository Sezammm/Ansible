---
- name: Install bind and tools
  ansible.builtin.yum:
    name:
      - bind
      - bind-utils
    state: present

# ---------- Zone files ----------

- name: Create forward zone file (ziyotek.local)
  ansible.builtin.template:
    src: ziyotek.local.db.j2
    dest: "{{ zone_file }}"
    owner: root
    group: named
    mode: '0644'
  notify: restart named

- name: Create reverse zone file (3.168.192.in-addr.arpa)
  ansible.builtin.template:
    src: reverse.3.168.192.in-addr.arpa.j2
    dest: "{{ reverse_zone_file }}"
    owner: root
    group: named
    mode: '0644'
  notify: restart named

# ---------- Basic named options tweaks ----------

- name: Allow DNS to listen on all interfaces (IPv4)
  ansible.builtin.replace:
    path: /etc/named.conf
    regexp: 'listen-on port 53\s*{[^}]*};'
    replace: 'listen-on port 53 { any; };'
  notify: restart named

- name: Allow DNS to listen on all interfaces (IPv6)
  ansible.builtin.replace:
    path: /etc/named.conf
    regexp: 'listen-on-v6 port 53\s*{[^}]*};'
    replace: 'listen-on-v6 port 53 { any; };'
  notify: restart named

- name: Allow DNS queries from any host
  ansible.builtin.replace:
    path: /etc/named.conf
    regexp: 'allow-query\s*{[^}]*};'
    replace: 'allow-query { any; };'
  notify: restart named

# ---------- Zone declarations in named.conf ----------

- name: Ensure forward zone block present
  ansible.builtin.blockinfile:
    path: /etc/named.conf
    marker: "// {mark} ANSIBLE MANAGED ZONE {{ zone_name }}"
    insertafter: 'include "/etc/named.rfc1912.zones";'
    block: |
      zone "{{ zone_name }}" IN {
          type master;
          file "{{ zone_file }}";
          allow-update { none; };
      };
  notify: restart named

- name: Ensure reverse zone block present
  ansible.builtin.blockinfile:
    path: /etc/named.conf
    marker: "// {mark} ANSIBLE MANAGED REVERSE ZONE"
    insertafter: 'include "/etc/named.rfc1912.zones";'
    block: |
      zone "{{ reverse_zone_name }}" IN {
          type master;
          file "{{ reverse_zone_file }}";
          allow-update { none; };
      };
  notify: restart named

# ---------- Forwarders ----------

- name: Configure forwarders comment line
  ansible.builtin.lineinfile:
    path: /etc/named.conf
    regexp: 'forwarders\s*{'
    insertafter: '^options'
    line: "    // forwarders will be managed by Ansible - see below"

- name: Replace options block forwarders
  ansible.builtin.replace:
    path: /etc/named.conf
    regexp: 'forwarders\s*{[^}]*};'
    replace: 'forwarders { {{ forwarders | join("; ") }}; };'
  ignore_errors: true
  notify: restart named

# ---------- SELinux / permissions ----------

- name: Fix ownership and SELinux context on zone files
  ansible.builtin.shell: |
    chown root:named "{{ zone_file }}" "{{ reverse_zone_file }}"
    restorecon -v "{{ zone_file }}" "{{ reverse_zone_file }}" || true
  changed_when: false

# ---------- Firewall ----------

- name: Open DNS TCP port in firewalld
  ansible.builtin.firewalld:
    port: 53/tcp
    permanent: true
    immediate: true
    state: enabled

- name: Open DNS UDP port in firewalld
  ansible.builtin.firewalld:
    port: 53/udp
    permanent: true
    immediate: true
    state: enabled

# ---------- Service ----------

- name: Ensure named service enabled and started
  ansible.builtin.service:
    name: named
    state: started
    enabled: true